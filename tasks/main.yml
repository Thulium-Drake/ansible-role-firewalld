---
- name: 'Ensure FirewallD is installed'
  ansible.builtin.package:
    name: 'firewalld'
    state: 'present'

- name: 'Ensure FirewallD is running'
  ansible.builtin.service:
    name: 'firewalld'
    state: 'started'

- name: 'Manage zones'
  ansible.builtin.include_tasks: 'tasks/manage_zone.yml'
  loop: "{{ firewalld_zones.keys() }}"
  loop_control:
    loop_var: 'zone'

- name: 'Remove unknown ports and serices'
  when: firewalld_prune_unknown
  block:
    - name: 'Collect current FirewallD configuration'
      ansible.posix.firewalld_info:
      register: 'firewalld_config'

    - name: 'Disable unknown zones'
      ansible.posix.firewalld:
        zone: "{{ zone }}"
        permanent: true
        state: 'disabled'
      loop: "{{ firewalld_config['collected_zones'] }}"
      loop_control:
        loop_var: 'zone'
      when: zone not in firewalld_zones.keys()

    - name: 'Prune managed zones'
      ansible.builtin.include_tasks: 'tasks/prune_zone.yml'
      loop: "{{ firewalld_zones.keys() }}"
      loop_control:
        loop_var: 'zone'
